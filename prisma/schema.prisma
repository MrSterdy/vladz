generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model WeekdayTimetable {
  weekday Int @unique

  offset Int

  note String? @db.VarChar(256)

  subjectLength Int
  subjectBreak  Int

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  subjects WeekdaySubject[]
}

model WeekdaySubject {
  name String @db.VarChar(128)

  length Int
  break  Int

  position Int

  teacher String? @db.VarChar(256)

  classroom String? @db.VarChar(128)

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  timetable        WeekdayTimetable @relation(fields: [timetableWeekday], references: [weekday], onDelete: Cascade)
  timetableWeekday Int

  @@unique([groupId, timetableWeekday, position])
}

model DateTimetable {
  date DateTime @unique @db.Date

  offset Int

  note String? @db.VarChar(256)

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  subjects DateSubject[]

  homeworks Homework[]
}

model DateSubject {
  name String @db.VarChar(128)

  length Int
  break  Int

  position Int

  teacher String? @db.VarChar(256)

  classroom String? @db.VarChar(128)

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  timetable     DateTimetable @relation(fields: [timetableDate], references: [date], onDelete: Cascade)
  timetableDate DateTime      @db.Date

  homework Homework?

  @@unique([groupId, timetableDate, position])
}

model Homework {
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  timetable     DateTimetable @relation(fields: [timetableDate], references: [date], onDelete: Cascade)
  timetableDate DateTime      @db.Date

  subject         DateSubject @relation(fields: [groupId, timetableDate, subjectPosition], references: [groupId, timetableDate, position], onDelete: Cascade)
  subjectPosition Int

  content String @db.Text

  @@unique([groupId, timetableDate, subjectPosition])
}

model Subject {
  name String @db.VarChar(128)

  teacher String? @db.VarChar(256)

  classroom String? @db.VarChar(128)

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  @@unique([name, groupId])
}

model Group {
  id Int @id @default(autoincrement())

  name String @db.VarChar(64)

  inviteCode String

  userGroups        UserGroup[]
  weekdayTimetables WeekdayTimetable[]
  weekdaySubjects   WeekdaySubject[]
  dateTimetables    DateTimetable[]
  dateSubjects      DateSubject[]
  subject           Subject[]
  homeworks         Homework[]
}

model User {
  id BigInt @id

  firstName String @db.VarChar(128)
  lastName  String @db.VarChar(128)

  role UserRole @default(USER)

  userGroups UserGroup[]
  userSecret UserSecret?
}

model UserGroup {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId BigInt

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId Int

  role GroupRole @default(APPLICATION)

  @@id([userId, groupId])
}

model UserSecret {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId BigInt @unique

  secret String
}

enum UserRole {
  ADMIN
  HELPER
  USER
}

enum GroupRole {
  CURATOR
  REDACTOR
  STUDENT
  APPLICATION
}
